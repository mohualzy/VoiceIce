<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘ä¿¡å·å¤„ç†å…¨æµç¨‹å¯è§†åŒ– (DSP Lab)</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        :root {
            --bg-color: #0e1117;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --accent-color: #2ea043;
            --border-color: #30363d;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1, h2, h3 { color: #fff; margin-bottom: 10px; }
        
        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .controls {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            height: fit-content;
        }

        .control-group {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .control-group:last-child { border-bottom: none; }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: bold;
            color: #8b949e;
        }

        input[type="range"] { width: 100%; margin: 5px 0; }
        select {
            width: 100%;
            padding: 8px;
            background: #0d1117;
            color: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .value-display { float: right; color: var(--accent-color); font-family: monospace; }

        /* å¯è§†åŒ–åŒºåŸŸæ ·å¼ */
        .visualizations {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .plot-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .step-badge {
            background-color: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        button {
            width: 100%;
            padding: 10px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover { background-color: #238636; }

    </style>
</head>
<body>

    <h1 style="text-align: center;">ğŸ›ï¸ éŸ³é¢‘ä¿¡å·å¤„ç†ç™½ç›’å®éªŒå®¤ (DSP Lab)</h1>
    <p style="text-align: center; color: #8b949e; margin-top: -10px;">ä» ç‰©ç†ä¿¡å· åˆ° æ•°å­—é¢‘è°± çš„å…¨è¿‡ç¨‹æ‹†è§£</p>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <h3>1. ä¿¡å·æºç”Ÿæˆ</h3>
                
                <label>ä¸»é¢‘ç‡ (Hz) <span id="val-freq1" class="value-display">50</span></label>
                <input type="range" id="freq1" min="10" max="1000" value="50">
                
                <label>äºŒæ¬¡è°æ³¢é¢‘ç‡ (Hz) <span id="val-freq2" class="value-display">150</span></label>
                <input type="range" id="freq2" min="10" max="2000" value="150">

                <label>å™ªå£°æ°´å¹³ (Noise) <span id="val-noise" class="value-display">0.2</span></label>
                <input type="range" id="noise" min="0" max="1" step="0.1" value="0.2">
            </div>

            <div class="control-group">
                <h3>2. é¢„å¤„ç† (åŠ çª—)</h3>
                <label>çª—å‡½æ•°ç±»å‹</label>
                <select id="windowType">
                    <option value="rect">çŸ©å½¢çª— (Rectangular - æ— å¤„ç†)</option>
                    <option value="hamming">æ±‰æ˜çª— (Hamming)</option>
                    <option value="hanning">æ±‰å®çª— (Hanning)</option>
                </select>
            </div>

            <div class="control-group">
                <h3>3. æ»¤æ³¢å™¨è®¾è®¡</h3>
                <label>æ»¤æ³¢å™¨ç±»å‹</label>
                <select id="filterType">
                    <option value="none">æ— æ»¤æ³¢ (None)</option>
                    <option value="lowpass">ä½é€š (Low Pass)</option>
                    <option value="highpass">é«˜é€š (High Pass)</option>
                </select>
                
                <label>æˆªæ­¢é¢‘ç‡ (Hz) <span id="val-cutoff" class="value-display">500</span></label>
                <input type="range" id="cutoff" min="50" max="3000" value="500">
            </div>

            <div class="control-group">
                <h3>4. æ’­æ”¾æ§åˆ¶</h3>
                <button onclick="playAudio()">ğŸ”Š æ’­æ”¾å½“å‰åˆæˆå£°éŸ³</button>
            </div>
        </div>

        <div class="visualizations">
            
            <div class="plot-card">
                <h2><span class="step-badge">Step 1</span>æ—¶åŸŸæ³¢å½¢ (Time Domain)</h2>
                <div id="plot-time" style="width:100%;height:300px;"></div>
                <p style="font-size: 0.9em; color: #8b949e;">
                    * åŸç†ï¼šè¿™æ˜¯ç©ºæ°”æŒ¯åŠ¨çš„æ•°å­—åŒ–è¡¨ç¤ºã€‚æ¨ªè½´æ˜¯æ—¶é—´ï¼Œçºµè½´æ˜¯å¹…åº¦ã€‚
                </p>
            </div>

            <div class="plot-card">
                <h2><span class="step-badge">Step 2</span>é¢‘åŸŸåˆ†æ (FFT Spectrum)</h2>
                <div id="plot-freq" style="width:100%;height:300px;"></div>
                <p style="font-size: 0.9em; color: #8b949e;">
                    * åŸç†ï¼šé€šè¿‡å¿«é€Ÿå‚…é‡Œå¶å˜æ¢ (FFT)ï¼Œå°†æ‚ä¹±çš„æ³¢å½¢æ‹†è§£ä¸ºä¸åŒé¢‘ç‡çš„æ­£å¼¦æ³¢ã€‚ä½ å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ä¸Šé¢çš„ä¸¤ä¸ªâ€œå°–å³°â€ä»£è¡¨ä½ è®¾ç½®çš„ä¸¤ä¸ªé¢‘ç‡ã€‚
                </p>
            </div>

        </div>
    </div>

    <script>
        // --- å…¨å±€å‚æ•° ---
        const SAMPLE_RATE = 8192; // é‡‡æ ·ç‡ï¼Œä¸ºäº†æ¼”ç¤ºFFTæ–¹ä¾¿ï¼Œå–2çš„å¹‚æ¬¡
        const DURATION = 0.5;     // ç§’
        const N_SAMPLES = SAMPLE_RATE * DURATION;

        // --- æ ¸å¿ƒ DSP é€»è¾‘ (JavaScript å®ç°) ---

        // 1. ç”Ÿæˆä¿¡å·
        function generateSignal(f1, f2, noiseLevel) {
            let t = [];
            let y = [];
            for (let i = 0; i < N_SAMPLES; i++) {
                let time = i / SAMPLE_RATE;
                // åˆæˆä¿¡å·ï¼šä¸¤ä¸ªæ­£å¼¦æ³¢ + éšæœºå™ªå£°
                let val = Math.sin(2 * Math.PI * f1 * time) + 
                          0.5 * Math.sin(2 * Math.PI * f2 * time) + 
                          (Math.random() - 0.5) * noiseLevel;
                t.push(time);
                y.push(val);
            }
            return { t, y };
        }

        // 2. åº”ç”¨çª—å‡½æ•°
        function applyWindow(y, type) {
            let windowed = [];
            for (let i = 0; i < y.length; i++) {
                let w = 1.0;
                // ç®€å•çš„çª—å‡½æ•°å…¬å¼å®ç°
                if (type === 'hanning') {
                    w = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (y.length - 1)));
                } else if (type === 'hamming') {
                    w = 0.54 - 0.46 * Math.cos((2 * Math.PI * i) / (y.length - 1));
                }
                windowed.push(y[i] * w);
            }
            return windowed;
        }

        // 3. ç®€å•çš„ IIR æ»¤æ³¢å™¨ (å•æç‚¹) - æ¨¡æ‹Ÿæ¼”ç¤ºç”¨
        function applyFilter(y, type, cutoff) {
            if (type === 'none') return y;

            let rc = 1.0 / (2 * Math.PI * cutoff);
            let dt = 1.0 / SAMPLE_RATE;
            let alpha = dt / (rc + dt);
            let filtered = [];
            let prev = y[0];

            if (type === 'lowpass') {
                for (let i = 0; i < y.length; i++) {
                    // y[i] = y[i-1] + alpha * (x[i] - y[i-1])
                    let val = prev + alpha * (y[i] - prev);
                    filtered.push(val);
                    prev = val;
                }
            } else if (type === 'highpass') {
                // ç®€å•é«˜é€šï¼šåŸä¿¡å·å‡å»ä½é€š
                // æ³¨æ„ï¼šè¿™æ˜¯æœ€ç®€åŒ–çš„ç®—æ³•ï¼Œä»…ä¾›æ¼”ç¤ºåŸç†
                let lowpassPrev = y[0];
                for (let i = 0; i < y.length; i++) {
                    let lp = lowpassPrev + alpha * (y[i] - lowpassPrev);
                    filtered.push(y[i] - lp);
                    lowpassPrev = lp;
                }
            }
            return filtered;
        }

        // 4. ç®€æ˜“ DFT (ç¦»æ•£å‚…é‡Œå¶å˜æ¢) - ä¸ºäº†ä¸å¼•å…¥åºå¤§çš„FFTåº“ï¼Œè¿™é‡Œç”¨ç®€åŒ–ç‰ˆ
        // æ³¨æ„ï¼šåœ¨JSä¸­å¤„ç†å¤§é‡æ•°æ®çš„FFTé€šå¸¸éœ€è¦WebAssemblyæˆ–å¤æ‚åº“ï¼Œ
        // è¿™é‡Œä¸ºäº†å•æ–‡ä»¶æ¼”ç¤ºï¼Œåªè®¡ç®—å¹…åº¦è°±çš„å‰åŠéƒ¨åˆ†ã€‚
        function computeSpectrum(signal) {
            const N = signal.length;
            // é™é‡‡æ ·ä»¥æé«˜æ¼”ç¤ºæ€§èƒ½ï¼Œå¦åˆ™æµè§ˆå™¨å¯èƒ½ä¼šå¡
            const step = 4; 
            const spectrumSize = Math.floor(N / 2);
            let freqs = [];
            let mags = [];

            // æˆ‘ä»¬åªè®¡ç®— 0Hz åˆ° 1000Hz (æˆ–æ›´é«˜) çš„å…³é”®éƒ¨åˆ†æ¥ç»˜å›¾ï¼Œé¿å…å…¨é‡è®¡ç®—å¡é¡¿
            // è¿™é‡Œçš„ç®—æ³•å¤æ‚åº¦æ˜¯ O(N^2)ï¼Œå¯¹äºæ¼”ç¤ºè¶³å¤Ÿï¼Œç”Ÿäº§ç¯å¢ƒè¯·ç”¨ FFT O(N log N)
            
            // ä¸ºäº†æ¼”ç¤ºæµç•…æ€§ï¼Œæˆ‘ä»¬åªè®¡ç®— 0Hz åˆ° 2000Hz çš„åŒºé—´
            const maxFreqToShow = 2000;
            const freqStep = 5; // Hz åˆ†è¾¨ç‡

            for (let f = 0; f < maxFreqToShow; f += freqStep) {
                let real = 0;
                let imag = 0;
                for (let i = 0; i < N; i+=step) {
                    let theta = -2 * Math.PI * f * (i / SAMPLE_RATE);
                    real += signal[i] * Math.cos(theta);
                    imag += signal[i] * Math.sin(theta);
                }
                // å¹…åº¦ = sqrt(re^2 + im^2)
                let magnitude = Math.sqrt(real * real + imag * imag) / (N/step) * 2; // å½’ä¸€åŒ–
                freqs.push(f);
                mags.push(magnitude);
            }
            return { freqs, mags };
        }

        // --- UI æ›´æ–°é€»è¾‘ ---

        function update() {
            // 1. è·å–ç”¨æˆ·è¾“å…¥
            const f1 = parseFloat(document.getElementById('freq1').value);
            const f2 = parseFloat(document.getElementById('freq2').value);
            const noise = parseFloat(document.getElementById('noise').value);
            const winType = document.getElementById('windowType').value;
            const filterType = document.getElementById('filterType').value;
            const cutoff = parseFloat(document.getElementById('cutoff').value);

            // æ›´æ–°æ•°å€¼æ˜¾ç¤º
            document.getElementById('val-freq1').innerText = f1;
            document.getElementById('val-freq2').innerText = f2;
            document.getElementById('val-noise').innerText = noise;
            document.getElementById('val-cutoff').innerText = cutoff;

            // 2. æ ¸å¿ƒå¤„ç†æµç¨‹
            let { t, y } = generateSignal(f1, f2, noise);  // ç”Ÿæˆ
            let y_filtered = applyFilter(y, filterType, cutoff); // æ»¤æ³¢
            let y_windowed = applyWindow(y_filtered, winType); // åŠ çª—
            let { freqs, mags } = computeSpectrum(y_windowed); // FFT

            // 3. ç»˜å›¾ (Plotly)
            
            // æ—¶åŸŸå›¾
            const traceTime = {
                x: t.slice(0, 500), // åªçœ‹å‰500ä¸ªç‚¹ï¼Œå¤ªå¯†çœ‹ä¸æ¸…
                y: y_windowed.slice(0, 500),
                mode: 'lines',
                name: 'Signal',
                line: { color: '#2ea043', width: 2 }
            };
            
            const layoutTime = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 10, r: 10, l: 40, b: 40 },
                xaxis: { title: 'Time (s)', color: '#8b949e', showgrid: true, gridcolor: '#30363d' },
                yaxis: { title: 'Amplitude', color: '#8b949e', showgrid: true, gridcolor: '#30363d' }
            };

            Plotly.newPlot('plot-time', [traceTime], layoutTime, {displayModeBar: false});

            // é¢‘åŸŸå›¾
            const traceFreq = {
                x: freqs,
                y: mags,
                type: 'bar', // æŸ±çŠ¶å›¾æ›´èƒ½è¡¨ç°ç¦»æ•£é¢‘ç‡
                marker: { color: '#ffa657' },
                name: 'Magnitude'
            };

            const layoutFreq = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 10, r: 10, l: 40, b: 40 },
                xaxis: { title: 'Frequency (Hz)', color: '#8b949e', showgrid: true, gridcolor: '#30363d' },
                yaxis: { title: 'Magnitude', color: '#8b949e', showgrid: true, gridcolor: '#30363d' }
            };

            Plotly.newPlot('plot-freq', [traceFreq], layoutFreq, {displayModeBar: false});
        }

        // --- ç®€å•çš„éŸ³é¢‘æ’­æ”¾ ---
        function playAudio() {
            // ä½¿ç”¨ Web Audio API
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const f1 = parseFloat(document.getElementById('freq1').value);
            const f2 = parseFloat(document.getElementById('freq2').value);
            
            const oscillator1 = audioCtx.createOscillator();
            const oscillator2 = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator1.type = 'sine';
            oscillator1.frequency.setValueAtTime(f1, audioCtx.currentTime);
            
            oscillator2.type = 'sine';
            oscillator2.frequency.setValueAtTime(f2, audioCtx.currentTime);

            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); // éŸ³é‡å°ä¸€ç‚¹

            oscillator1.connect(gainNode);
            oscillator2.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator1.start();
            oscillator2.start();

            // æ’­æ”¾1ç§’ååœæ­¢
            oscillator1.stop(audioCtx.currentTime + 1);
            oscillator2.stop(audioCtx.currentTime + 1);
        }

        // --- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ ---
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('input', update);
        });

        // é¦–æ¬¡è¿è¡Œ
        update();

    </script>
</body>
</html>